<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Матричный дождь с логотипом</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
            font-family: monospace;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        #matrixCanvas {
            z-index: 20;
        }

        #recordButton {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 100;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.5);
            color: rgba(150, 150, 150, 0.8);
            border: 1px solid rgba(150, 150, 150, 0.5);
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
            transition: background-color 0.3s, color 0.3s;
        }

        #recordButton:hover {
            background-color: rgba(0, 0, 0, 0.8);
            color: #666;
        }

        #recordingStatus {
            position: fixed;
            bottom: 48px;
            right: 10px;
            z-index: 100;
            font-family: monospace;
            color: rgba(255, 0, 0, 0.8);
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 4px;
            display: none;
        }

        #recordingFrame {
            position: absolute;
            border: 2px dashed rgba(255, 0, 0, 0.5);
            z-index: 50;
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="matrixCanvas"></canvas>
    <canvas id="logoCanvas"></canvas>
    <div id="recordingFrame"></div>
    <button id="recordButton">Запись</button>
    <div id="recordingStatus">Идет запись...</div>

    <script>
        // Основные элементы
        const matrixCanvas = document.getElementById('matrixCanvas');
        const matrixCtx = matrixCanvas.getContext('2d');
        const logoCanvas = document.getElementById('logoCanvas');
        const logoCtx = logoCanvas.getContext('2d', { willReadFrequently: true });
        const recordButton = document.getElementById('recordButton');
        const recordingStatus = document.getElementById('recordingStatus');
        const recordingFrame = document.getElementById('recordingFrame');

        // Переменные для записи видео
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let recordingStream = null;
        let recordingCanvas = null;
        let recordingCtx = null;

        // Цвета для фонового дождя
        const backgroundRainColor = "transparent";
        const backgroundRainColorFull = "transparent";

        // Настройка размеров
        function resizeCanvases() {
            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;
            logoCanvas.width = window.innerWidth;
            logoCanvas.height = window.innerHeight;
            
            // Обновляем размер и положение рамки записи
            updateRecordingFrame();
        }
        
        // Обновление рамки записи
        function updateRecordingFrame() {
            // Расчет размеров области записи (высота браузера, ширина = высота/2)
            const height = window.innerHeight;
            const width = height / 1.4;
            
            // Центрирование по горизонтали
            const left = (window.innerWidth - width) / 2;
            
            // Обновляем стили рамки
            recordingFrame.style.top = '0px';
            recordingFrame.style.left = left + 'px';
            recordingFrame.style.width = width + 'px';
            recordingFrame.style.height = height + 'px';
        }
        
        resizeCanvases();

        // Настройки матрицы
        const fontSize = 8; // Уменьшенный размер шрифта символов (было 14)
        let columns = Math.floor(matrixCanvas.width / fontSize);
        let rows = Math.floor(matrixCanvas.height / fontSize);

        // Символы матрицы
        const symbols = "◯";
        const symbolArray = symbols.split('');

        // Капли дождя
        let drops = [];

        // Маска логотипа
        let logoMask = new Uint8Array(columns * rows);
        let logoLoaded = false;

        // Время последнего кадра для анимации
        let lastFrameTime = 0;
        const frameRate = 30;

        // Градиентные цвета для логотипа (бирюзово-голубые оттенки)
        const gradientColors = [
            [83, 167, 253],  // Голубой
            [52, 152, 219],  // Другой оттенок голубого
            [39, 229, 215],  // Бирюзовый
            [26, 188, 156]   // Другой оттенок бирюзового
        ];

        // Функция для создания маски из изображения
function createMaskFromImage(img) {
    // Проверяем, что изображение загружено
    if (!img.complete || !img.naturalWidth) {
        console.error("Изображение не загружено");
        return;
    }
    
    // Создаем временный невидимый холст для обработки изображения
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = logoCanvas.width;
    tempCanvas.height = logoCanvas.height;
    const tempCtx = tempCanvas.getContext('2d');
    
    // Рассчитываем размер логотипа, чтобы он занимал почти всю высоту холста, сохраняя пропорции
    const logoRatio = img.width / img.height;
    let logoWidth, logoHeight;
    
    // Поскольку новый логотип вертикальный, задаем высоту в приоритете
    logoHeight = logoCanvas.height * 0.9; // Занимает 90% высоты экрана
    logoWidth = logoHeight * logoRatio;
    
    // Если логотип слишком широкий - ограничиваем ширину
    if (logoWidth > logoCanvas.width * 0.7) {
        logoWidth = logoCanvas.width * 0.7;
        logoHeight = logoWidth / logoRatio;
    }
    
    // Вычисляем координаты для центрирования
    const offsetX = (logoCanvas.width - logoWidth) / 2;
    const offsetY = (logoCanvas.height - logoHeight) / 2;
    
    // Рисуем логотип на временном холсте (не видимом пользователю)
    tempCtx.drawImage(img, offsetX, offsetY, logoWidth, logoHeight);
    
    // Получаем данные пикселей с временного холста
    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
    const pixels = imageData.data;
    
    // Обновляем маску логотипа в соответствии с новыми размерами
    logoMask = new Uint8Array(columns * rows);
    
    // Создаем маску с высокой детализацией
    for (let y = 0; y < rows; y++) {
        for (let x = 0; x < columns; x++) {
            // Координаты пикселя на холсте
            const canvasX = x * fontSize;
            const canvasY = y * fontSize;
            
            // Проверяем, что координаты внутри холста
            if (canvasX >= 0 && canvasX < tempCanvas.width && 
                canvasY >= 0 && canvasY < tempCanvas.height) {
                
                // Индекс в массиве пикселей (RGBA)
                const i = (canvasY * tempCanvas.width + canvasX) * 4;
                
                // Проверяем прозрачность (альфа-канал)
                const alpha = pixels[i + 3];
                
                // Учитываем непрозрачные пиксели
                if (alpha > 30) {
                    logoMask[y * columns + x] = 1;
                }
            }
        }
    }
    
    // Применяем сглаживание краев для более плавного контура
    const tempMask = new Uint8Array(logoMask.length);
    for (let y = 1; y < rows - 1; y++) {
        for (let x = 1; x < columns - 1; x++) {
            const idx = y * columns + x;
            
            // Подсчитываем количество соседних пикселей в маске
            let count = 0;
            for (let dy = -1; dy <= 1; dy++) {
                for (let dx = -1; dx <= 1; dx++) {
                    count += logoMask[(y + dy) * columns + (x + dx)];
                }
            }
            
            // Если более 2 соседей - это часть логотипа
            tempMask[idx] = (count >= 2) ? 1 : 0;
        }
    }
    
    // Копируем обработанную маску обратно
    for (let i = 0; i < logoMask.length; i++) {
        logoMask[i] = tempMask[i];
    }
    
    logoLoaded = true;
    console.log("Логотип загружен и маска создана");
}

        // Получение цвета градиента
        function getGradientColor(position) {
            // position от 0 до 1
            const segmentCount = gradientColors.length - 1;
            const segmentPosition = position * segmentCount;
            const segmentIndex = Math.floor(segmentPosition);
            const segmentOffset = segmentPosition - segmentIndex;
            
            // Получаем два ближайших цвета для интерполяции
            const color1 = gradientColors[segmentIndex];
            const color2 = gradientColors[Math.min(segmentIndex + 1, gradientColors.length - 1)];
            
            // Интерполяция между цветами
            const r = Math.round(color1[0] + segmentOffset * (color2[0] - color1[0]));
            const g = Math.round(color1[1] + segmentOffset * (color2[1] - color1[1]));
            const b = Math.round(color1[2] + segmentOffset * (color2[2] - color1[2]));
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        // Инициализация капель дождя
        function initDrops() {
            drops = [];

            // Создаем много капель для высокой плотности
            for (let i = 0; i < columns * 4; i++) {
                drops.push(Math.floor(Math.random() * rows));
            }
        }

        // Создание и загрузка встроенного SVG логотипа
        function loadSVGLogo() {
            // Используем новый SVG логотип
            const svgLogo = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->

<svg
   width="41.499332mm"
   height="287.56815mm"
   viewBox="0 0 41.499332 287.56815"
   version="1.1"
   id="svg1"
   xml:space="preserve"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg"><defs
     id="defs1" /><g
     id="layer1"
     transform="translate(-81.188737,-4.4622567)"><path
       style="fill:#000000;stroke-width:0.316286"
       d="m 82.396792,104.75907 c 1.015426,-3.79709 1.757844,-4.973282 4.399726,-6.970504 2.503257,-1.892411 5.380094,-3.155157 7.180289,-3.15168 0.725622,0.0014 1.548968,-0.185809 1.829662,-0.416023 0.340928,-0.279613 2.724021,-0.362932 7.178391,-0.250981 7.89229,0.198359 10.38079,0.831378 14.22627,3.618868 3.32939,2.41339 4.47694,4.45765 5.19656,9.25736 0.72917,4.86332 -0.009,10.75605 -1.69108,13.49089 -1.4178,2.3058 -4.55358,4.77983 -7.61174,6.00541 -2.19514,0.87972 -3.31648,1.0363 -9.06592,1.26587 -3.75531,0.14995 -6.749253,0.11462 -7.0013,-0.0827 -0.242205,-0.18953 -1.182505,-0.34982 -2.089572,-0.35619 -2.798191,-0.0197 -9.305875,-3.10788 -9.302158,-4.41432 8.94e-4,-0.3145 -0.210499,-0.57221 -0.46977,-0.57272 -0.720341,-0.001 -2.305236,-2.37099 -2.307355,-3.44977 -0.0011,-0.52637 -0.312773,-1.45106 -0.692747,-2.05487 -0.95283,-1.51408 -0.833108,-7.97798 0.220744,-11.91872 z m 9.31849,7.48284 c 0.255518,4.9e-4 0.464053,0.18466 0.463413,0.40925 -0.0025,0.89875 2.458513,2.99551 4.528537,3.85817 1.206814,0.50294 2.298447,1.01675 2.425857,1.14179 0.472292,0.46358 3.249961,0.72038 3.251161,0.30058 6.9e-4,-0.24525 0.57445,-0.34624 1.39443,-0.24545 0.76627,0.0942 1.39353,0.0635 1.39391,-0.0684 3.7e-4,-0.13177 0.6807,-0.4418 1.51183,-0.68892 1.53527,-0.45649 2.90818,-1.38131 5.00283,-3.37001 0.90011,-0.85458 1.16507,-1.53108 1.16993,-2.98696 0.004,-1.16603 -0.2145,-1.94328 -0.57399,-2.04278 -0.31915,-0.0883 -0.58936,-0.36162 -0.6005,-0.60728 -0.0112,-0.24566 -0.8593,-0.96507 -1.88481,-1.59869 -1.02554,-0.63362 -2.32,-1.49745 -2.87663,-1.91962 -1.40794,-1.06786 -8.4218,-1.15321 -9.348748,-0.11377 -0.328007,0.36783 -0.831839,0.66832 -1.119633,0.66776 -0.765567,-0.002 -3.74806,2.72065 -4.080812,3.72455 -0.156913,0.47343 -0.4717,0.86041 -0.699509,0.85997 -0.227811,-4.4e-4 -0.415919,0.60214 -0.418016,1.33903 -0.0021,0.73692 0.205247,1.34024 0.460752,1.34074 z M 102.82551,95.234482 c 0.73047,-0.230315 0.73141,-0.272831 0.0136,-0.606836 -0.42463,-0.197544 -1.12681,-0.247783 -1.5604,-0.11164 -0.73427,0.230552 -0.73519,0.272176 -0.0136,0.606838 0.4262,0.19762 1.12839,0.247855 1.5604,0.111638 z m -0.58253,31.550398 c 1.51252,-0.0181 1.60446,-0.0667 0.69739,-0.3693 -0.92855,-0.30961 -2.43803,-0.16125 -2.43917,0.23974 -2.4e-4,0.0828 0.78356,0.14106 1.74178,0.12956 z m 12.08241,-15.55202 c 0.12967,-0.26294 0.13089,-0.69361 0.003,-0.95704 -0.12817,-0.26343 -0.23418,-0.0483 -0.23568,0.47806 -10e-4,0.52637 0.10338,0.74191 0.23296,0.47898 z m -32.698028,62.90956 c 0.116493,-0.99987 0.409484,-1.81757 0.651004,-1.8171 0.241504,4.7e-4 0.440492,-0.48221 0.442172,-1.07264 0.0059,-2.08671 4.925103,-6.95605 7.02314,-6.95201 0.413716,8.1e-4 1.22409,-0.33419 1.800822,-0.74441 1.417972,-1.00857 4.274767,-1.34033 11.18133,-1.29846 5.69885,0.0345 11.14421,0.89425 11.14175,1.75904 -5.2e-4,0.18173 0.32259,0.33105 0.71803,0.33181 1.11517,0.002 5.27123,3.66395 6.21172,5.47299 1.93974,3.73113 2.28419,13.38543 0.61556,17.25358 -1.3748,3.18702 -6.66721,7.51597 -9.18281,7.5111 -0.42478,-8.2e-4 -0.77276,0.1516 -0.77329,0.33872 -0.001,0.52595 -2.57541,0.8016 -9.23018,0.98846 -3.899831,0.10951 -6.103674,0.0334 -6.10298,-0.21064 5.98e-4,-0.21011 -0.835144,-0.38363 -1.8572,-0.38561 -1.022056,-0.002 -1.857794,-0.17586 -1.857195,-0.38639 5.98e-4,-0.21055 -0.52156,-0.38383 -1.160334,-0.38505 -0.638786,-10e-4 -1.160946,-0.17452 -1.160347,-0.38506 5.99e-4,-0.21055 -0.283057,-0.38337 -0.630362,-0.38403 -1.310021,-0.002 -4.91989,-3.14523 -6.303152,-5.48742 -1.29856,-2.19877 -1.415225,-2.74468 -1.571145,-7.35202 -0.09257,-2.73729 -0.07306,-5.79498 0.04343,-6.79486 z m 9.894102,6.23982 c 0.255516,5e-4 0.463841,0.2588 0.462944,0.57401 -0.0025,0.87466 3.062968,3.49125 4.755354,4.05906 0.826884,0.27744 1.652063,0.68677 1.833754,0.90961 0.443395,0.54387 6.344824,0.53575 6.770234,-0.01 0.18298,-0.23445 0.81304,-0.54882 1.40012,-0.6986 1.57991,-0.40307 5.21493,-3.45341 5.21757,-4.37835 0.001,-0.43986 0.23868,-0.7993 0.52762,-0.79874 0.77025,0.001 0.19382,-2.42088 -0.8268,-3.47453 -2.84819,-2.94035 -4.74565,-4.1981 -6.98184,-4.62799 -2.71305,-0.52155 -6.04864,-0.20413 -7.546607,0.71816 -2.799464,1.72363 -4.708315,3.31645 -4.961752,4.14029 -0.153522,0.49907 -0.465524,0.90706 -0.693333,0.90662 -0.227811,-4.4e-4 -0.415919,0.60212 -0.418014,1.33903 -0.0021,0.73691 0.205245,1.34024 0.46075,1.34073 z m 22.609016,-0.62625 c 0.12967,-0.26293 0.1309,-0.6936 0.003,-0.95703 -0.12817,-0.26343 -0.23418,-0.0483 -0.23567,0.47807 -0.001,0.52636 0.10337,0.74189 0.23295,0.47896 z m -32.564741,66.45086 c 0.451612,-2.82663 1.868132,-5.32452 4.192025,-7.39221 2.381509,-2.11894 6.87746,-4.07081 9.365721,-4.066 1.000027,0.002 1.818646,-0.14411 1.819159,-0.32453 5.13e-4,-0.18043 2.561658,-0.24741 5.691446,-0.14883 6.81157,0.21453 10.69519,1.21776 13.97948,3.6112 3.6515,2.66105 5.00077,5.37896 5.66352,11.4084 0.29242,2.6601 -0.79929,9.83383 -1.83553,12.06158 -0.50989,1.0962 -0.52501,1.09984 -3.56619,0.85717 -1.67977,-0.13404 -4.25621,-0.24726 -5.72541,-0.25159 l -2.67128,-0.008 0.003,-1.19233 c 0.003,-1.14141 2.07012,-4.83181 3.01477,-5.38287 0.24868,-0.14507 0.53021,-1.43652 0.6256,-2.8699 0.15073,-2.26487 0.0326,-2.75553 -0.90176,-3.74708 -1.7212,-1.82644 -3.54823,-3.1783 -5.03091,-3.72254 -0.75798,-0.2782 -1.37776,-0.63605 -1.37731,-0.7952 10e-4,-0.43591 -5.475212,-0.35835 -5.807404,0.0823 -0.15852,0.21022 -0.689442,0.38146 -1.179841,0.38052 -1.342627,-0.002 -6.033552,4.01059 -6.036835,5.16464 -0.0014,0.52178 -0.211756,0.9483 -0.467273,0.94781 -1.085833,-0.002 -0.122208,5.5107 1.104463,6.31855 1.009214,0.66462 1.659298,2.00908 1.655275,3.42334 l -0.0038,1.365 -3.419436,-0.007 c -1.880697,-0.003 -4.358079,0.0976 -5.505293,0.22489 -2.499834,0.27742 -2.496122,0.28247 -3.407047,-4.64444 -0.672481,-3.63718 -0.738526,-7.79407 -0.179451,-11.29334 z m 21.073711,-10.51996 c 0.9967,-0.25899 1.00117,-0.27976 0.1157,-0.53807 -0.50652,-0.14777 -1.31421,-0.18475 -1.79487,-0.0821 -0.78372,0.16726 -0.79566,0.22281 -0.11571,0.53807 0.417,0.19337 1.22471,0.23035 1.79488,0.0821 z m -0.16479,-231.1860445 19.97658,0.038581 -0.0136,4.7851364 -0.0136,4.7851341 -19.97658,-0.03858 -19.976567,-0.03859 0.01362,-4.7851341 0.01362,-4.7851362 z M 83.984811,12.60119 c 0.433831,0.119136 0.582604,-0.664114 0.589544,-3.1038541 0.0086,-3.0268637 -0.548995,-4.6005406 -1.07292,-3.0280529 -0.464579,1.3943194 -0.103771,5.970657 0.483376,6.131907 z m 18.435529,9.508947 19.9808,0.03859 -0.0132,4.437928 -0.0132,4.437926 -9.47001,5.30549 c -10.94427,6.131424 -11.06214,5.640212 1.30936,5.456984 l 8.13038,-0.120416 -0.0132,4.596452 -0.0132,4.59645 -19.97658,-0.03858 -19.976568,-0.03858 0.03533,-4.366632 0.03533,-4.366635 3.699848,-2.156686 c 2.034907,-1.186177 6.107834,-3.500228 9.050935,-5.142333 2.943105,-1.642104 5.560615,-3.149289 5.816705,-3.349302 0.29535,-0.230681 -3.016913,-0.323088 -9.058484,-0.25271 l -9.524076,0.110948 0.0091,-4.59374 0.0091,-4.593738 z m -18.526948,7.11182 c 0.694164,0.63504 1.761954,0.711509 11.263623,0.806658 l 10.496755,0.105107 -10.685759,0.196142 -10.685759,0.196142 10.80186,0.0064 c 6.879778,0.004 10.802248,-0.132641 10.802938,-0.376457 6.9e-4,-0.241134 -3.95354,-0.428479 -10.684289,-0.506207 l -10.685378,-0.123399 0.0075,-2.65003 c 0.0041,-1.457517 -0.183385,-2.747771 -0.416743,-2.867232 -1.150259,-0.588867 -1.346655,4.177458 -0.214787,5.212914 z M 83.766008,48.67961 c 0.606211,0.416547 0.696424,0.155324 0.702653,-2.034651 0.0039,-1.381902 -0.183776,-2.61029 -0.417135,-2.729754 -1.088927,-0.557461 -1.363468,4.023707 -0.285518,4.764405 z m 18.568922,1.475974 c 13.94042,-0.05051 18.09556,-0.174289 18.24602,-0.543543 0.15405,-0.378047 -3.58191,-0.466834 -17.84629,-0.424124 l -18.041098,0.05402 17.885398,0.244035 17.88542,0.244037 -18.44379,-0.04688 c -10.144085,-0.02577 -18.284727,0.08469 -18.090321,0.245491 0.194405,0.160794 8.476508,0.262923 18.404661,0.226953 z m -0.015,8.51299 19.97657,0.03858 -0.0352,4.411061 -0.0352,4.41106 -5.79381,3.262249 c -3.1866,1.794236 -7.40887,4.150789 -9.38282,5.236785 l -3.58901,1.974535 9.39022,0.121312 9.39023,0.121311 -0.0132,4.490552 -0.0132,4.490552 -19.97662,-0.03859 -19.976565,-0.03858 0.03536,-4.376678 c 0.02805,-3.472662 0.17468,-4.414291 0.709819,-4.558784 0.370953,-0.100158 0.8841,-0.387836 1.140333,-0.639276 0.758996,-0.744819 14.035762,-8.195316 14.60208,-8.194222 0.285937,5.51e-4 0.520247,-0.131363 0.520707,-0.293141 4.61e-4,-0.161781 0.576618,-0.597198 1.280336,-0.967595 1.2423,-0.65387 0.99589,-0.670832 -8.476816,-0.583551 l -9.756302,0.08989 0.01277,-4.498026 0.01277,-4.498029 z m -19.017764,7.014008 c 0.638026,1.379712 1.110498,0.432814 1.118103,-2.240817 0.0075,-2.623993 -0.50642,-3.961028 -1.077104,-2.802454 -0.341589,0.693451 -0.371144,4.329357 -0.04094,5.043271 z m -0.05553,19.523351 c 0.624322,1.350103 1.110423,0.458693 1.117558,-2.04941 0.007,-2.462432 -0.52086,-3.741406 -1.077648,-2.611048 -0.341668,0.693613 -0.369533,3.947678 -0.03986,4.660458 z m 18.858204,49.067787 19.97657,0.0386 -0.0321,11.29292 -0.0321,11.29292 -4.99413,-0.01 -4.99415,-0.01 0.0188,-6.60348 0.0188,-6.60349 -2.78743,-0.005 -2.78743,-0.005 -0.0177,6.22067 -0.0177,6.22068 -4.87799,-0.01 -4.878008,-0.01 0.0177,-6.22067 0.0177,-6.22068 -7.317001,-0.0141 -7.316999,-0.0141 0.01334,-4.68944 0.01334,-4.68943 z m -19.019411,7.58822 c 0.674871,1.45939 1.11072,0.35493 1.119801,-2.83762 0.0054,-1.89492 -0.183929,-3.44567 -0.420707,-3.44613 -0.236777,-4.5e-4 -0.52697,0.30044 -0.644879,0.66867 -0.330582,1.03252 -0.368273,4.93593 -0.0543,5.61508 z m 18.737911,13.58141 c 1.82918,-0.0684 3.00878,-0.29004 3.12907,-0.58793 0.14201,-0.35164 -0.65702,-0.47978 -3.02019,-0.48434 -1.76732,-0.003 -3.356484,0.11123 -3.531488,0.25476 -0.720579,0.59097 0.660204,0.92079 3.422608,0.81751 z m -0.24099,-0.56452 c 1.78858,0.005 2.46317,0.0756 1.49904,0.15665 -0.96411,0.0811 -2.4275,0.0768 -3.251983,-0.01 -0.824478,-0.0862 -0.03565,-0.15244 1.752943,-0.14729 z m 0.32881,47.72654 19.97658,0.0385 -0.16444,7.94314 c -0.21773,10.51783 -0.61141,13.13088 -2.24254,14.8845 -1.99324,2.14291 -4.28059,2.78983 -9.86096,2.7889 -2.87168,-1.2e-4 -4.76145,-0.15274 -4.76079,-0.3836 6e-4,-0.21054 -0.66451,-0.38409 -1.47803,-0.38566 -1.15957,-0.002 -1.94479,-0.40284 -3.634583,-1.85422 l -2.155469,-1.85136 -6.37151,3.55756 c -4.785745,2.67212 -6.744059,3.55683 -7.86845,3.55469 l -1.496954,-0.003 0.05146,-5.40627 0.05146,-5.40624 6.47753,-3.38559 c 3.562646,-1.86207 6.634333,-3.3854 6.825968,-3.3852 0.191636,2.1e-4 0.349482,-0.36546 0.350754,-0.81261 0.0022,-0.79929 -0.113188,-0.81051 -6.850571,-0.66582 l -6.852894,0.14717 0.01339,-4.70676 0.01339,-4.70677 z m -19.009911,7.18898 0.286959,1.19684 6.353005,0.0123 c 4.444403,0.009 6.537544,0.15638 6.967217,0.49197 0.495687,0.38714 0.573633,0.36883 0.404006,-0.095 -0.168479,-0.46058 -1.447413,-0.61502 -6.443751,-0.77808 l -6.233562,-0.20343 -0.125948,-3.15845 c -0.114939,-2.88137 -0.567972,-3.91483 -1.175779,-2.68196 -0.344819,0.69944 -0.36413,3.83115 -0.03209,5.21576 z m 0.148138,18.80597 c 0.270596,5.2e-4 0.362302,0.17296 0.20378,0.38321 -0.158507,0.21023 -0.06681,0.38267 0.203781,0.3832 0.614425,0.001 0.699005,-7.13182 0.08834,-7.44448 -0.672472,-0.34426 -0.894326,0.52891 -0.942697,3.71041 -0.02818,1.85185 0.139764,2.96706 0.446863,2.96766 z m 27.764133,-17.65527 c 1.47876,-0.0734 0.38903,-0.13851 -2.42164,-0.14479 -2.81065,-0.007 -4.02054,0.0537 -2.68864,0.13334 1.3319,0.0797 3.63153,0.0849 5.11028,0.011 z m -4.71658,6.36852 c 2.04652,1.69428 3.3572,1.76227 4.59861,0.23856 0.51283,-0.62943 1.0892,-1.14463 1.28084,-1.14486 0.19163,-2e-4 0.35136,-1.03402 0.35496,-2.29729 l 0.007,-2.29687 -3.94886,-0.008 -3.94885,-0.008 -0.006,2.06717 c -0.005,1.86302 0.15891,2.20361 1.66265,3.44853 z m -4.61806,51.82786 c 10.85326,0.0863 19.77319,0.18998 19.82209,0.23044 0.0489,0.0405 0.14368,5.15519 0.21069,11.36605 l 0.12181,11.29247 -4.99414,-0.01 -4.99414,-0.01 0.0193,-6.7949 0.0193,-6.79489 -2.55515,-0.005 -2.55514,-0.005 -0.018,6.31638 -0.018,6.31641 -3.13587,-0.002 c -1.72474,-8e-5 -3.873422,0.0972 -4.774856,0.21839 l -1.638986,0.22024 0.200715,-6.54365 0.200714,-6.54365 -3.125128,-0.007 -3.125123,-0.007 0.151921,6.79523 0.151922,6.79525 -4.88131,-0.01 -4.881296,-0.01 0.03267,-11.48434 0.03267,-11.48432 z m -18.814161,20.86834 c 0.846329,1.83015 1.112602,-0.30704 1.137702,-9.13144 0.02464,-8.66321 -0.263568,-11.30486 -1.057504,-9.69304 -0.340635,0.69151 -0.414793,18.10089 -0.08015,18.82448 z m 7.381709,0.62123 c 0.287176,5.3e-4 0.520287,-2.55729 0.610488,-6.69881 0.133147,-6.11433 -0.03178,-7.20808 -0.970865,-6.43788 -0.517276,0.42426 -0.168528,13.1357 0.360377,13.13669 z m 0.14169,-9.85862 c 0.07996,1.84243 0.07139,4.85706 -0.01905,6.69918 -0.09045,1.8421 -0.155795,0.33466 -0.145313,-3.3499 0.01054,-3.68455 0.08443,-5.19174 0.164368,-3.34928 z m 8.344372,5.96788 c 0.09152,-1.62157 0.09977,-4.3778 0.01848,-6.12497 -0.08129,-1.74716 -0.156161,-0.42043 -0.166335,2.94831 -0.01027,3.36873 0.05642,4.79822 0.147834,3.17666 z"
       id="path3" /></g></svg>`;
            
            // Конвертируем SVG в Data URL
            const svgBlob = new Blob([svgLogo], {type: 'image/svg+xml'});
            const svgUrl = URL.createObjectURL(svgBlob);
            
            // Загружаем SVG и создаем маску
            const tempImg = new Image();
            tempImg.onload = function() {
                createMaskFromImage(tempImg);
                URL.revokeObjectURL(svgUrl); // Освобождаем память
            };
            tempImg.onerror = function() {
                console.error("Не удалось загрузить SVG логотип");
                logoLoaded = false;
            };
            tempImg.src = svgUrl;
        }

        // Главная функция анимации
        function animate(currentTime) {
            // Ограничиваем частоту кадров
            if (currentTime - lastFrameTime < 1000 / frameRate) {
                requestAnimationFrame(animate);
                return;
            }

            lastFrameTime = currentTime;

            // Затемнение фона для эффекта следа
            matrixCtx.fillStyle = "rgba(0, 0, 0, 0.07)"; // Более быстрое затухание
            matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);

            // Рисуем матричный дождь
            drawMatrixRain();

            // Если идет запись, копируем область видео на записывающий холст
            if (isRecording && recordingCtx) {
                const height = window.innerHeight;
                const width = height / 1.4;
                const left = (window.innerWidth - width) / 2;
                
                // Копируем только нужную область на холст записи
                recordingCtx.drawImage(matrixCanvas, left, 0, width, height, 0, 0, width, height);
                
                // Также копируем слой с логотипом, если он есть
                if (logoCanvas) {
                    recordingCtx.drawImage(logoCanvas, left, 0, width, height, 0, 0, width, height);
                }
            }

            // Продолжаем анимацию
            requestAnimationFrame(animate);
        }

        // Отрисовка матричного дождя
        function drawMatrixRain() {
            // Фоновые символы с низкой непрозрачностью
            for (let i = 0; i < columns; i++) {
                for (let j = 0; j < rows; j++) {
                    // Рисуем символ с вероятностью 5%
                    if (Math.random() > 0.95) {
                        const symbol = symbolArray[Math.floor(Math.random() * symbolArray.length)];
                        const isInLogo = logoLoaded && logoMask[j * columns + i] === 1;

                        if (isInLogo) {
                            // Бирюзово-голубой градиент для логотипа
                            const gradientColor = getGradientColor(j / rows);
                            matrixCtx.fillStyle = gradientColor;
                            matrixCtx.font = `bold ${fontSize}px monospace`;
                        } else {
                            // Серый цвет для фона вместо зеленого
                            matrixCtx.fillStyle = backgroundRainColor;
                            matrixCtx.font = `${fontSize}px monospace`;
                        }

                        matrixCtx.fillText(symbol, i * fontSize, j * fontSize);
                    }
                }
            }

            // Основные капли дождя
            for (let idx = 0; idx < drops.length; idx++) {
                const i = idx % columns; // Колонка
                const dropY = Math.floor(drops[idx]); // Текущая Y-позиция капли
                
                // Проверяем, находится ли капля в области логотипа
                const isInLogo = logoLoaded && dropY < rows && logoMask[dropY * columns + i] === 1;

                // Выбираем случайный символ
                const symbol = symbolArray[Math.floor(Math.random() * symbolArray.length)];
                
                // Настраиваем стиль в зависимости от положения
                if (isInLogo) {
                    // Для логотипа используем бирюзово-голубой градиент
                    const gradientPos = dropY / rows;
                    matrixCtx.fillStyle = getGradientColor(gradientPos);
                    matrixCtx.font = `bold ${fontSize + 1}px monospace`; // Слегка увеличенный размер для логотипа
                } else {
                    // Серый цвет для дождя вместо зеленого
                    matrixCtx.fillStyle = backgroundRainColorFull;
                    matrixCtx.font = `${fontSize}px monospace`;
                }

                // Рисуем символ
                matrixCtx.fillText(symbol, i * fontSize, dropY * fontSize);

                // Сбрасываем каплю, если она достигла низа
                if (dropY * fontSize > matrixCanvas.height && Math.random() > 0.95) {
                    drops[idx] = 0;
                } else {
                    // Увеличиваем скорость для капель в области логотипа
                    drops[idx] += isInLogo ? 0.5 : 1.5; // Капли в логотипе движутся медленнее
                }
            }
            
            // Добавляем больше капель в области логотипа для лучшей видимости
            if (logoLoaded && Math.random() > 0.7) {
                // Собираем список всех позиций в маске
                let logoPositions = [];
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < columns; x++) {
                        if (logoMask[y * columns + x] === 1) {
                            logoPositions.push({x, y});
                        }
                    }
                }
                
                // Если найдены позиции логотипа
                if (logoPositions.length > 0) {
                    // Выбираем случайную точку в логотипе
                    const pos = logoPositions[Math.floor(Math.random() * logoPositions.length)];
                    
                    // Находим ближайшую каплю в этой колонке
                    let closestDropIdx = -1;
                    let minDistance = rows;
                    
                    for (let idx = 0; idx < drops.length; idx++) {
                        if (idx % columns === pos.x) {
                            const distance = Math.abs(drops[idx] - pos.y);
                            if (distance < minDistance) {
                                minDistance = distance;
                                closestDropIdx = idx;
                            }
                        }
                    }
                    
                    // Если расстояние больше порогового, добавляем новую каплю
                    if (minDistance > 5 && closestDropIdx !== -1) {
                        // Устанавливаем каплю сверху логотипа
                        drops[closestDropIdx] = Math.max(0, pos.y - Math.random() * 5);
                    }
                }
            }
        }
        
        // Функция начала записи
        function startRecording() {
            // Если уже записываем, выходим
            if (isRecording) return;
            
            // Параметры области записи
            const height = window.innerHeight;
            const width = height / 1.4;
            
            // Создаем холст для записи
            recordingCanvas = document.createElement('canvas');
            recordingCanvas.width = width;
            recordingCanvas.height = height;
            recordingCtx = recordingCanvas.getContext('2d');
            
            // Устанавливаем черный фон
            recordingCtx.fillStyle = '#000';
            recordingCtx.fillRect(0, 0, width, height);
            
            // Получаем поток с холста
            recordingStream = recordingCanvas.captureStream(30); // 30fps
            
            // Настраиваем медиа-рекордер
            const options = {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 5000000 // 5 Mbps для высокого качества
            };
            
            // Пробуем создать рекордер с высоким качеством, если не получится - используем значения по умолчанию
            try {
                mediaRecorder = new MediaRecorder(recordingStream, options);
            } catch (e) {
                console.log('Не удалось создать MediaRecorder с указанными опциями, используем значения по умолчанию');
                mediaRecorder = new MediaRecorder(recordingStream);
            }
            
            // Настраиваем обработчики событий рекордера
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                // Создаем blob из записанных данных
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                
                // Создаем ссылку на скачивание
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'matrix-rain-' + new Date().toISOString() + '.webm';
                
                // Добавляем к документу, запускаем скачивание и удаляем
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // Освобождаем память
                if (recordingStream) {
                    recordingStream.getTracks().forEach(track => track.stop());
                    recordingStream = null;
                }
                
                recordingCanvas = null;
                recordingCtx = null;
                
                // Скрываем индикатор записи
                recordingStatus.style.display = 'none';
                recordingFrame.style.display = 'none';
                recordButton.textContent = 'Запись';
            };
            
            // Начинаем запись
            recordedChunks = [];
            mediaRecorder.start();
            isRecording = true;
            
            // Показываем индикатор записи
            recordingStatus.style.display = 'block';
            recordingFrame.style.display = 'block';
            recordButton.textContent = 'Остановить';
        }
        
        // Функция остановки записи
        function stopRecording() {
            if (!isRecording) return;
            
            mediaRecorder.stop();
            isRecording = false;
        }
        
        // Обработчик кнопки записи
        recordButton.addEventListener('click', function() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        // Инициализация
        function init() {
            // Инициализируем капли дождя
            initDrops();
            
            // Загружаем логотип
            loadSVGLogo();
            
            // Начинаем анимацию
            requestAnimationFrame(animate);
            
            // Показываем рамку для области записи
            updateRecordingFrame();
        }

        // Обработка изменения размеров окна
        window.addEventListener('resize', () => {
            // Обновляем размеры холстов
            resizeCanvases();
            
            // Обновляем количество колонок и строк
            columns = Math.floor(matrixCanvas.width / fontSize);
            rows = Math.floor(matrixCanvas.height / fontSize);
            
            // Инициализируем новые капли дождя
            initDrops();
            
            // Перезагружаем логотип
            loadSVGLogo();
        });

        // Запускаем инициализацию после загрузки страницы
        window.addEventListener('load', init);
    </script>
</body>
</html>
